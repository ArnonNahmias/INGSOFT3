# Azure DevOps Pipeline para Posts App (Self-Hosted Agent Windows)
# Trigger: activar en cambios en main
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - TP4/posts-app/front/*
      - TP4/posts-app/back/*
      - TP4/posts-app/azure-pipelines.yml

# Pool: usar el agente self-hosted que ya está configurado
pool:
  name: 'MypoolLocal'
  demands:
    - Agent.Name -equals ARNON

# Variables globales
variables:
  buildConfiguration: 'Release'
  projectPath: 'TP4/posts-app'
  frontendPath: 'TP4/posts-app/front'
  backendPath: 'TP4/posts-app/back'
  nodeVersion: '18.x'
  nodePath: 'C:\Program Files\nodejs'

# Stages del pipeline
stages:
  # ========================
  # STAGE 1: CI (Build)
  # ========================
  - stage: CI
    displayName: 'Continuous Integration'
    jobs:
      # Job: Build Frontend
      - job: BuildFrontend
        displayName: 'Build Frontend (Next.js)'
        steps:
          - checkout: self
            fetchDepth: 1
            
          - task: PowerShell@2
            displayName: 'Debug: Complete Directory Analysis'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "======================================"
                Write-Host "COMPLETE DIRECTORY ANALYSIS"
                Write-Host "======================================"
                Write-Host ""
                Write-Host "Build.SourcesDirectory: $(Build.SourcesDirectory)"
                Write-Host "Working Directory: $(pwd)"
                Write-Host "Agent.WorkFolder: $(Agent.WorkFolder)"
                Write-Host ""
                
                Write-Host "=== ROOT DIRECTORY CONTENTS ==="
                try {
                  Get-ChildItem "$(Build.SourcesDirectory)" -Force | ForEach-Object { 
                    Write-Host "$($_.Mode) $($_.Name)" 
                  }
                } catch { Write-Host "ERROR listing root: $($_.Exception.Message)" }
                Write-Host ""
                
                Write-Host "=== SEARCHING FOR TP4 RECURSIVELY ==="
                try {
                  Get-ChildItem "$(Build.SourcesDirectory)" -Recurse -Directory -Name "TP4" -ErrorAction SilentlyContinue | ForEach-Object {
                    Write-Host "Found TP4 at: $_"
                  }
                } catch { Write-Host "No TP4 found" }
                Write-Host ""
                
                Write-Host "=== SEARCHING FOR posts-app RECURSIVELY ==="
                try {
                  Get-ChildItem "$(Build.SourcesDirectory)" -Recurse -Directory -Name "posts-app" -ErrorAction SilentlyContinue | ForEach-Object {
                    Write-Host "Found posts-app at: $_"
                  }
                } catch { Write-Host "No posts-app found" }
                Write-Host ""
                
                Write-Host "=== SEARCHING FOR package.json FILES ==="
                try {
                  Get-ChildItem "$(Build.SourcesDirectory)" -Recurse -File -Name "package.json" -ErrorAction SilentlyContinue | ForEach-Object {
                    Write-Host "Found package.json at: $_"
                  }
                } catch { Write-Host "No package.json found" }
                Write-Host ""
                
                Write-Host "=== TESTING EXPECTED PATHS ==="
                $expectedPaths = @(
                  "$(Build.SourcesDirectory)\TP4",
                  "$(Build.SourcesDirectory)\TP4\posts-app", 
                  "$(Build.SourcesDirectory)\$(frontendPath)",
                  "$(Build.SourcesDirectory)\$(backendPath)"
                )
                foreach ($path in $expectedPaths) {
                  if (Test-Path $path) { 
                    Write-Host "✅ EXISTS: $path"
                  } else { 
                    Write-Host "❌ MISSING: $path"
                  }
                }
                Write-Host "======================================"
            
          - task: PowerShell@2
            displayName: 'Verify Node.js Installation'
            inputs:
              targetType: 'inline'
              script: |
                & "$(nodePath)\node.exe" --version
                & "$(nodePath)\npm.cmd" --version
              
          - task: PowerShell@2
            displayName: 'Install Frontend Dependencies'
            inputs:
              targetType: 'inline'
              script: |
                $frontendDir = "$(Build.SourcesDirectory)\$(frontendPath)"
                Write-Host "Attempting to change to: $frontendDir"
                
                if (Test-Path $frontendDir) {
                  Write-Host "✅ Frontend directory exists!"
                  cd $frontendDir
                  Write-Host "Current directory: $(pwd)"
                  
                  if (Test-Path "package.json") {
                    Write-Host "✅ package.json found, installing dependencies..."
                    & "$(nodePath)\npm.cmd" install
                  } else {
                    Write-Host "❌ package.json not found in frontend directory"
                    exit 1
                  }
                } else {
                  Write-Host "❌ Frontend directory does not exist: $frontendDir"
                  Write-Host "Available directories in SourcesDirectory:"
                  Get-ChildItem "$(Build.SourcesDirectory)" -Directory -Recurse -Depth 2 | ForEach-Object { Write-Host "  $($_.FullName)" }
                  exit 1
                }
            
          - task: PowerShell@2
            displayName: 'Build Frontend'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(Build.SourcesDirectory)\$(frontendPath)"
                & "$(nodePath)\npm.cmd" run build
            
          - task: PowerShell@2
            displayName: 'Lint Frontend'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(Build.SourcesDirectory)\$(frontendPath)"
                & "$(nodePath)\npm.cmd" run lint
            continueOnError: true
            
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Frontend Artifacts'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/$(frontendPath)/.next'
              ArtifactName: 'frontend-build'
              publishLocation: 'Container'

      # Job: Build Backend
      - job: BuildBackend
        displayName: 'Build Backend (Express + TypeScript)'
        steps:
          - checkout: self
            fetchDepth: 1
            
          - task: PowerShell@2
            displayName: 'Verify Node.js Installation'
            inputs:
              targetType: 'inline'
              script: |
                & "$(nodePath)\node.exe" --version
                & "$(nodePath)\npm.cmd" --version
              
          - task: PowerShell@2
            displayName: 'Install Backend Dependencies'
            inputs:
              targetType: 'inline'
              script: |
                $backendDir = "$(Build.SourcesDirectory)\$(backendPath)"
                Write-Host "Attempting to change to: $backendDir"
                
                if (Test-Path $backendDir) {
                  Write-Host "✅ Backend directory exists!"
                  cd $backendDir
                  Write-Host "Current directory: $(pwd)"
                  
                  if (Test-Path "package.json") {
                    Write-Host "✅ package.json found, installing dependencies..."
                    & "$(nodePath)\npm.cmd" install
                  } else {
                    Write-Host "❌ package.json not found in backend directory"
                    exit 1
                  }
                } else {
                  Write-Host "❌ Backend directory does not exist: $backendDir"
                  Write-Host "Available directories in SourcesDirectory:"
                  Get-ChildItem "$(Build.SourcesDirectory)" -Directory -Recurse -Depth 2 | ForEach-Object { Write-Host "  $($_.FullName)" }
                  exit 1
                }
            
          - task: PowerShell@2
            displayName: 'Build Backend (TypeScript)'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(Build.SourcesDirectory)\$(backendPath)"
                & "$(nodePath)\npm.cmd" run build
            
          - script: |
              cd $(backendPath)
              echo "Skipping lint for backend (no lint script configured)"
            displayName: 'Lint Backend'
            continueOnError: true
            
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Backend Artifacts'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/$(backendPath)/dist'
              ArtifactName: 'backend-build'
              publishLocation: 'Container'

  # ========================
  # STAGE 2: Database Setup
  # ========================
  - stage: DatabaseSetup
    displayName: 'Database Configuration'
    dependsOn: CI
    condition: succeeded()
    jobs:
      - job: CheckDatabase
        displayName: 'Verify Database Connection'
        steps:
          - task: PowerShell@2
            displayName: 'Setup MySQL Database'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(Build.SourcesDirectory)\$(backendPath)"
                & "$(nodePath)\npm.cmd" run setup-db
            
          - script: |
              echo "=== Database Configuration Check ==="
              echo "Database Host: localhost"
              echo "Database Name: posts_app"
              echo "Database User: root"
              echo "MySQL Server: 8.4 (Local Windows Installation)"
              echo "✅ Database setup completed successfully"
            displayName: 'Database Connection Verification'

  # ========================
  # STAGE 3: Health Check
  # ========================
  - stage: HealthCheck
    displayName: 'Application Health Verification'
    dependsOn: DatabaseSetup
    condition: succeeded()
    jobs:
      - job: ApplicationHealth
        displayName: 'Verify Application Health'
        steps:
          - script: |
              echo "=== Application Health Check ==="
              echo "✅ Frontend build completed successfully"
              echo "✅ Backend build completed successfully"
              echo "✅ Database configuration verified"
              echo "📦 Artifacts published and ready for deployment"
              echo ""
              echo "=== Next Steps ==="
              echo "1. Configure self-hosted agent with proper permissions"
              echo "2. Update pipeline to use SelfHosted pool"
              echo "3. Deploy to local environment with MySQL access"
            displayName: 'Health Status Summary'
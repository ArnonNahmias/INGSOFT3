# Azure DevOps Pipeline para Posts App (Hosted Agents)
# Trigger: activar en cambios en main
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - front/*
      - back/*
      - azure-pipelines.yml

# Pool: usar agentes hospedados por Microsoft
pool:
  vmImage: 'ubuntu-latest'

# Variables globales
variables:
  buildConfiguration: 'Release'
  frontendPath: 'front'
  backendPath: 'back'
  nodeVersion: '18.x'

# Stages del pipeline
stages:
  # ========================
  # STAGE 1: CI (Build)
  # ========================
  - stage: CI
    displayName: 'Continuous Integration'
    jobs:
      # Job: Build Frontend
      - job: BuildFrontend
        displayName: 'Build Frontend (Next.js)'
        steps:
          - checkout: self
            fetchDepth: 1
            
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(nodeVersion)
              
          - script: |
              cd $(frontendPath)
              npm ci
            displayName: 'Install Frontend Dependencies'
            
          - script: |
              cd $(frontendPath)
              npm run build
            displayName: 'Build Frontend'
            
          - script: |
              cd $(frontendPath)
              npm run lint
            displayName: 'Lint Frontend'
            continueOnError: true
            
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Frontend Artifacts'
            inputs:
              PathtoPublish: '$(frontendPath)/.next'
              ArtifactName: 'frontend-build'
              publishLocation: 'Container'

      # Job: Build Backend
      - job: BuildBackend
        displayName: 'Build Backend (Express + TypeScript)'
        steps:
          - checkout: self
            fetchDepth: 1
            
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(nodeVersion)
              
          - script: |
              cd $(backendPath)
              npm ci
            displayName: 'Install Backend Dependencies'
            
          - script: |
              cd $(backendPath)
              npm run build
            displayName: 'Build Backend (TypeScript)'
            
          - script: |
              cd $(backendPath)
              npm run lint
            displayName: 'Lint Backend'
            continueOnError: true
            
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Backend Artifacts'
            inputs:
              PathtoPublish: '$(backendPath)/dist'
              ArtifactName: 'backend-build'
              publishLocation: 'Container'

  # ========================
  # STAGE 2: Database Setup
  # ========================
  - stage: DatabaseSetup
    displayName: 'Database Configuration'
    dependsOn: CI
    condition: succeeded()
    jobs:
      - job: CheckDatabase
        displayName: 'Verify Database Connection'
        steps:
          - script: |
              echo "=== Database Configuration Check ==="
              echo "Database Host: localhost"
              echo "Database Name: posts_app"
              echo "Database User: root"
              echo "Note: En un agente hospedado no hay acceso a MySQL local"
              echo "Esta etapa simula la verificaciÃ³n de la base de datos"
            displayName: 'Database Connection Info'

  # ========================
  # STAGE 3: Health Check
  # ========================
  - stage: HealthCheck
    displayName: 'Application Health Verification'
    dependsOn: DatabaseSetup
    condition: succeeded()
    jobs:
      - job: ApplicationHealth
        displayName: 'Verify Application Health'
        steps:
          - script: |
              echo "=== Application Health Check ==="
              echo "âœ… Frontend build completed successfully"
              echo "âœ… Backend build completed successfully"
              echo "âœ… Database configuration verified"
              echo "ðŸ“¦ Artifacts published and ready for deployment"
              echo ""
              echo "=== Next Steps ==="
              echo "1. Configure self-hosted agent with proper permissions"
              echo "2. Update pipeline to use SelfHosted pool"
              echo "3. Deploy to local environment with MySQL access"
            displayName: 'Health Status Summary'